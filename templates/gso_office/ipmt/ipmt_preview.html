{% extends "gso_office/gso_base_dashboard.html" %}
{% block title %}IPMT Preview{% endblock %}

{% block main_content %}
<div class="header d-flex align-items-center justify-content-between mb-3">
    <h1 class="page-title">IPMT Preview - {{ month_filter }}</h1>
    <div class="btn-group">
        <button id="edit-btn" class="btn btn-warning">Edit</button>
        <button id="accept-btn" class="btn btn-success">Accept / Export</button>
        <button id="save-btn" class="btn btn-primary d-none">Save</button>
        <button id="cancel-btn" class="btn btn-secondary d-none">Cancel</button>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-bordered" id="ipmt-table">
        <thead>
            <tr>
                <th>Success Indicators</th>
                <th>Actual Accomplishments</th>
                <th>Remarks</th>
            </tr>
        </thead>
        <tbody>
            {% for row in reports %}
            <tr data-row-id="{{ forloop.counter0 }}" data-war-ids="{{ row.war_ids|join:',' }}">
                <td>{{ row.indicator }}</td>
                <td>
                    <span class="desc-text">{{ row.description|default:"" }}</span>
                    <input class="desc-input form-control d-none" type="text" value="{{ row.description|default:"" }}">
                </td>
                <td>
                    <span class="remarks-text">{{ row.remarks|default:"" }}</span>
                    <input class="remarks-input form-control d-none" type="text" value="{{ row.remarks|default:"" }}">
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const editBtn = document.getElementById("edit-btn");
    const acceptBtn = document.getElementById("accept-btn");
    const saveBtn = document.getElementById("save-btn");
    const cancelBtn = document.getElementById("cancel-btn");

    const table = document.getElementById("ipmt-table");
    const rows = table.querySelectorAll("tbody tr");

    let editMode = false;
    let originalData = [];

    function enterEditMode() {
        editMode = true;
        originalData = [];

        rows.forEach(row => {
            const descInput = row.querySelector(".desc-input");
            const remarksInput = row.querySelector(".remarks-input");
            const descText = row.querySelector(".desc-text");
            const remarksText = row.querySelector(".remarks-text");

            originalData.push({desc: descInput.value, remarks: remarksInput.value});

            descText.classList.add("d-none");
            remarksText.classList.add("d-none");
            descInput.classList.remove("d-none");
            remarksInput.classList.remove("d-none");
        });

        editBtn.classList.add("d-none");
        acceptBtn.classList.add("d-none");
        saveBtn.classList.remove("d-none");
        cancelBtn.classList.remove("d-none");
    }

    function exitEditMode() {
        editMode = false;
        rows.forEach((row, index) => {
            const descInput = row.querySelector(".desc-input");
            const remarksInput = row.querySelector(".remarks-input");
            const descText = row.querySelector(".desc-text");
            const remarksText = row.querySelector(".remarks-text");

            descText.textContent = descInput.value;
            remarksText.textContent = remarksInput.value;

            descText.classList.remove("d-none");
            remarksText.classList.remove("d-none");
            descInput.classList.add("d-none");
            remarksInput.classList.add("d-none");
        });

        editBtn.classList.remove("d-none");
        acceptBtn.classList.remove("d-none");
        saveBtn.classList.add("d-none");
        cancelBtn.classList.add("d-none");
    }

    editBtn.addEventListener("click", enterEditMode);
    cancelBtn.addEventListener("click", function() {
        rows.forEach((row, index) => {
            const descInput = row.querySelector(".desc-input");
            const remarksInput = row.querySelector(".remarks-input");
            descInput.value = originalData[index].desc;
            remarksInput.value = originalData[index].remarks;
        });
        exitEditMode();
    });

    saveBtn.addEventListener("click", async function() {
        const payload = [];
        rows.forEach(row => {
            const descInput = row.querySelector(".desc-input");
            const remarksInput = row.querySelector(".remarks-input");
            payload.push({
                indicator: row.children[0].textContent.trim(),
                description: descInput.value.trim(),
                remarks: remarksInput.value.trim(),
                war_ids: row.dataset.warIds.split(",").filter(Boolean).map(Number)
            });
        });

        const response = await fetch("{% url 'gso_reports:save_ipmt' %}", {
            method: "POST",
            headers: {"Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}"},
            body: JSON.stringify({
                month: "{{ month_filter }}",
                unit: "{{ unit_filter }}",
                personnel: {{ personnel_names|safe }},
                rows: payload
            })
        });

        if (response.ok) {
            alert("IPMT saved successfully!");
            exitEditMode();
        } else {
            alert("Error saving IPMT.");
        }
    });

    acceptBtn.addEventListener("click", function() {
        const urlParams = new URLSearchParams({month: "{{ month_filter }}", unit: "{{ unit_filter }}"});
        window.location.href = "{% url 'gso_reports:generate_ipmt' %}?" + urlParams.toString();
    });
});
</script>
{% endblock %}
